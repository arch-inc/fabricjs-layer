!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@arch-inc/fabricjs-psbrush")):"function"==typeof define&&define.amd?define(["exports","@arch-inc/fabricjs-psbrush"],e):e((t=t||self).layer={},t.psbrush)}(this,(function(t,e){"use strict";function i(t){var e=Number.MAX_VALUE,i=Number.MAX_VALUE;return t.forEach((function(t){e=Math.min(e,t.aCoords.tl.x),i=Math.min(i,t.aCoords.tl.y)})),{left:e,top:i}}var r="undefined"==typeof fabric?require("fabric").fabric:fabric,s=r.util.createClass(r.Group,{original:null,erasedPath:null,type:"ErasedGroup",startTime:null,endTime:null,initialize:function(t,e,i,r){i=i||{},this.original=t,this.erasedPath=e,this.callSuper("initialize",[this.original,this.erasedPath],i,r),this.startTime=i.startTime,this.endTime=i.endTime},_calcBounds:function(t){var e=[],i=[],r=["tr","br","bl","tl"],s=r.length,a=this.original;a.setCoords(!0);for(var n=0;n<s;n++){var o=r[n];e.push(a.oCoords[o].x),i.push(a.oCoords[o].y)}this._getBounds(e,i,t)},needsItsOwnCache:function(){return!(!this.group||"LayerGroup"!=this.group.type)},toObject:function(t){return this.callSuper("toObject",["startTime","endTime"].concat(t))},ungroup:function(){!function(t){var e=t.original,i=t.group||t.canvas,r=i.getObjects().findIndex((function(e){return e===t}));t.destroy(),i.remove(t),i.insertAt(e,r,!1);var s=e.getObjects();e.destroy(),i.remove(e);for(var a=0;a<s.length;a++)i.insertAt(s[a],r+a,!1)}(this)},_toSVG:function(){var t=this.erasedPath.globalCompositeOperation,e=this.erasedPath.stroke;this.erasedPath.globalCompositeOperation="source-over",this.erasedPath.stroke="#ffffff";var i=this.callSuper("_toSVG");return this.erasedPath.globalCompositeOperation=t,this.erasedPath.stroke=e,i}});s.fromObject=function(t,e){r.util.enlivenObjects(t.objects,(function(i){var r=i.find((function(t){return"group"===t.type})),a=i.find((function(t){return"path"===t.type})),n=new s(r,a,t);e&&e(n)}),null,null)},r.ErasedGroup=s;var a="undefined"==typeof fabric?require("fabric").fabric:fabric,n=a.util.createClass(a.PencilBrush,{rasterize:!1,simplify:null,simplifyTolerance:0,simplifyHighestQuality:!1,scope:null,currentStartTime:null,initialize:function(t,i){this.simplify=new(i&&i.Simplify||e.Simplify),this.canvas=t,this._points=[]},_prepareForDrawing:function(t){this.callSuper("_prepareForDrawing",t),this.currentStartTime=Date.now()},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath(),this.simplifyTolerance>0&&(this.simplify.tolerance=this.simplifyTolerance,this._points=this.simplify.do(this._points,this.simplifyHighestQuality)),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var t=this.convertPointsToSVGPath(this._points).join("");if("M 0 0 Q 0 0 0 0 L 0 0"!==t){var e,r=this.createPath(t);r.globalCompositeOperation="destination-out",r.stroke="#000000",r.selectable=!1,r.evented=!1,(e={}).startTime=this.currentStartTime,e.endTime=Date.now();var n=this.scope||this.canvas,o=function(t,e){var r=t.getObjects(),s=Number.MAX_VALUE,a=Number.MAX_VALUE,n=-1,o=-1;r.forEach((function(t,i){s=Math.min(s,t.aCoords.tl.x),a=Math.min(a,t.aCoords.tl.y);var r=t.intersectsWithObject(e);return r&&(n<0&&(n=i),o=i),r}));var l=n<0?[]:r.slice(n,o+1);return{overlapped:{objects:l,topLeft:i(l),index:n},all:{objects:r,topLeft:{left:s,top:a}}}}(n,r),l=o.overlapped,c=o.all;if(this.rasterize||l.objects.length!==c.objects.length&&(e.left=l.topLeft.left,e.top=l.topLeft.top),l.objects.length>0){var h=new a.Group(l.objects),u=new s(h,r,e);if(this.rasterize){var f=u.toDataURL({withoutTransform:!0});a.Image.fromURL(f,(function(t){t.set(l.topLeft),n.remove.apply(n,l.objects),n instanceof a.Group?n.addWithUpdate(t):n.add(t)}))}else{n.remove.apply(n,l.objects),n.add(u);var p=n._objects;p.splice(p.length-1,1),p.splice(l.index,0,u)}this.canvas.fire("erased-group:added",{target:u}),u.fire("added")}this.canvas.renderAll(),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow()}else this.canvas.requestRenderAll()}});a.EraserBrush=n,t.ErasedGroup=s,t.EraserBrush=n,Object.defineProperty(t,"__esModule",{value:!0})}));
